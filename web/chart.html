<!DOCTYPE html>
<html lang='en'>
  <head>
		<meta content='text/html;charset=utf-8' http-equiv='Content-Type'>
    <meta property='og:site_name' content='Protect Playa Now' />
    <title>Gas monitor readings - Protect Playa Now</title>
    <script type='text/javascript' src='https://www.gstatic.com/charts/loader.js'></script>
    <link rel='stylesheet' href='chart.css'>
  </head>
  <body>
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/jquery-ui.min.js'></script>
    <p>
      <span class='label'>Start </span>
      <input type='text' class='datepicker' style='width:170px;' id='startPicker'>
    </p>
    <p>
      <span class='label'>End </span>
      <input type='text' class='datepicker' style='width:170px;' id='endPicker'>
    </p>
	  <span class='label'>Show last</span>
    <select id='timeInterval' onchange='populateDatePickers(hoursAgoDate(this.value))'>
      <option value='1'>1 hour</option>
      <option value='6'>6 hours</option>
      <option value='24'>24 hours</option>
    </select>
    <p>
      <span class='label'>Device </span>
      <select id='devices'></select>
  		<span class='div'>
		  <select id='dataType'>
		    <option value='raw'>Raw sensor value</option>
		    <option value='ppm'>PPM estimate</option>
		  </select>
		  <span class='div'/>
      <button id='update' onclick='getDataAndDrawChart()'>Update chart</button>
      <div id='chart_div'></div>
    </p>
  <script>
google.charts.load('current', {'packages':['corechart']});
google.setOnLoadCallback(populateDevices);

var urlBase = 'http://34.223.248.143';
var dataType = 'reading';
var chart;
var chartData;
var chartOptions = {
  legend: {position: 'none'},
  chartArea: {
    width: '90%',
    height: '90%'
  },
  enableInteractivity: true,
  hAxis: {
    gridlines: {
      count: -1,
      units: {
        days: {format: ['MMM dd']},
        hours: {format: ['HH:mm', 'ha']},
      }
    },
    minorGridlines: {
      units: {
        hours: {format: ['hh:mm:ss a', 'ha']},
        minutes: {format: ['HH:mm a Z', ':mm']}
      }
    }
  }
};

function timeStr(d) {
  var h = d.getHours();
  var m = d.getMinutes();
  var s = d.getSeconds();
  if (h < 10) h = '0' + h;
  if (m < 10) m = '0' + h;
  if (s < 10) s = '0' + h;
  return h + ':' + m + ':' + s;
}

function formatDateForDisplay(d) {
  // Example output: 04/03/2018 00:00:00
  var year = d.getFullYear();
  var month = 1 + d.getMonth();
  var day = d.getDate();
  if (month < 10) month = '0' + month;
  if (day < 10) day = '0' + day;
  return month + '/' + day + '/' + year + ' ' + timeStr(d);
}

function formatDateForServer(d) {
  // Example output: 2018-04-03T00:00:00-08:00
  var year = d.getFullYear();
  var month = 1 + d.getMonth();
  var day = d.getDate();
  var z = d.getTimezoneOffset() / 60;
  var a = Math.round(Math.abs(z));
  if (month < 10) month = '0' + month;
  if (day < 10) day = '0' + day;
  if (a < 10) a = '0' + a;
  var tz = (z < 0 ? '+' : '-') + a + ':00';
  return year + '-' + month + '-'  + day + 'T' + timeStr(d) + tz;  
}

function hoursAgoDate(hours) {
  var date = new Date();
  date.setHours(date.getHours() - hours);
  return date;
}

function populateDatePickers(startTime) {
	$('#startPicker').val(formatDateForDisplay(startTime));
	$('#endPicker').val(formatDateForDisplay(new Date()));
}

function getDataAndDrawChart() {
  var start = new Date($('#startPicker').val());
  var end = new Date($('#endPicker').val());
  var startParam = '&startDateTime=' + formatDateForServer(start);
  var endParam = '&endDateTime=' +  formatDateForServer(end);
  var deviceParam = '&deviceId=' + $('#devices option:selected').text();
  var url = urlBase + '/readings?gasName=methane' + deviceParam + startParam + endParam;
  console.log('url: ' + url);
  $('select,button').prop('disabled', true);
  $.getJSON(url, function(data) {
    console.log('Received data size: ' + data.length);
    chartData = new google.visualization.DataTable();
    chartData.addColumn('datetime', 'Time of Day');
    chartData.addColumn('number', '');
    chart = new google.visualization.LineChart($('#chart_div')[0]);
    chart.clearChart();
    var x;
    var l = data.length
    for (i = 0; i < l; i++) {
      x = data[i];
      chartData.addRows([
        [
          new Date(x.instant),
          $('#dataType').val() == 'raw' ?  x.input : x.reading
        ]
      ]);
    }
    chart.draw(chartData, chartOptions);
    $('select,button').prop('disabled', false);
  });
};

function populateDevices() {
  var $dropdown = $('#devices');
  var url = urlBase + '/devices?ids=true';
  $.getJSON(url, function(devIds) {
    var isSel = false;
    var id;
    for (i = 0; i < devIds.length; i++) {
      id = devIds[i]
      if (!isSel && id.startsWith('RaspPi-GasMonitor')) {
        $dropdown.append($('<option selected/>').val(id).text(id));
        isSel = true;
      } else if (!id.startsWith('zTest')) {
        $dropdown.append($('<option />').val(id).text(id));
      }
    }
    getDataAndDrawChart();
  });
}

populateDatePickers(hoursAgoDate(1));

$('#chart_div')[0].setAttribute('style', 'height:' + (window.innerHeight - 220) + 'px');
$('#endPicker').datepicker({
  onSelect: function(dateText) {
    $('#endPicker').val(dateText + ' ' + timeStr(new Date()));
  }
});

$('#startPicker').datepicker({
  onSelect: function(dateText) {
    $('#startPicker').val(dateText + ' ' + timeStr(new Date()));
  }
});

$(window).resize(function() {
  if (this.resizeTO) clearTimeout(this.resizeTO);
  this.resizeTO = setTimeout(function() {
    $(this).trigger('resizeEnd');
  }, 500);
});

$(window).on('resizeEnd', function() {
  $('#chart_div')[0].setAttribute('style', 'height:' + (window.innerHeight - 250) + 'px');
  chart.draw(chartData, chartOptions);
});

    </script>
  </body>
</html>
